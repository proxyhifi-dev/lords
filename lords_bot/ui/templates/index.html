<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lords Bot</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; background: #f5f6f8; color: #222; }
    .card { background: #fff; border-radius: 10px; padding: 18px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    button { padding: 10px 14px; margin-right: 10px; border: 0; border-radius: 6px; cursor: pointer; }
    .primary { background: #2b65d9; color: #fff; }
    .success { background: #177a3f; color: #fff; }
    pre { background: #1f2937; color: #e5e7eb; padding: 12px; border-radius: 8px; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>Lords ORB Bot</h1>

  <div class="card">
    <h3>Account</h3>
    <p><strong>Mode:</strong> {{ mode }}</p>
    <p><strong>Capital:</strong> {{ '%.2f'|format(capital|default(0.0)) }}</p>
    <p><strong>Total PnL:</strong> {{ '%.2f'|format(pnl) }}</p>
  </div>

  <div class="card">
    <button class="primary" onclick="scanMarket()">Scan</button>
    <button class="success" onclick="approveTrade()">Approve Trade</button>
    <button onclick="monitorTrade()">Monitor</button>
    <button onclick="location.reload()">Refresh</button>
    <button onclick="resetDay()">Reset Daily State</button>
  </div>


  <div class="card">
    <h3>Projected Trade Metrics</h3>
    <p><strong>ORB High/Low:</strong> <span id="orbRange">NA</span></p>
    <p><strong>Signal Direction:</strong> <span id="signalDirection">NA</span></p>
    <p><strong>Risk Amount:</strong> <span id="riskAmount">NA</span></p>
    <p><strong>Lot Size:</strong> <span id="lotSize">NA</span></p>
    <p><strong>Projected SL:</strong> <span id="projectedSL">NA</span></p>
    <p><strong>Projected Target:</strong> <span id="projectedTarget">NA</span></p>
  </div>

  <div class="card">
    <h3>Signal</h3>
    <pre id="signalBox">{{ signal | tojson(indent=2) if signal else 'No signal yet' }}</pre>
  </div>

  <div class="card">
    <h3>Active Trade</h3>
    <pre id="tradeBox">{{ trade | tojson(indent=2) if trade else 'No active trade' }}</pre>
  </div>

  <div class="card">
    <h3>Monitor Result</h3>
    <pre id="monitorBox">{{ monitor_result | tojson(indent=2) if monitor_result else 'Not started' }}</pre>
  </div>

  <script>
    function updateProjectedMetrics(payload) {
      const sig = payload.signal || payload;
      const breakout = sig.breakout || {};
      document.getElementById('orbRange').textContent = (breakout.range_high && breakout.range_low) ? `${breakout.range_high} / ${breakout.range_low}` : 'NA';
      document.getElementById('signalDirection').textContent = sig.direction || breakout.direction || 'NA';
      document.getElementById('riskAmount').textContent = sig.risk_amount ?? 'NA';
      document.getElementById('lotSize').textContent = sig.lot_size ?? 'NA';
      document.getElementById('projectedSL').textContent = sig.projected_stop_loss ?? 'NA';
      document.getElementById('projectedTarget').textContent = sig.projected_target ?? 'NA';
    }

    async function scanMarket() {
      const res = await fetch('/scan', { method: 'POST' });
      const data = await res.json();
      document.getElementById('signalBox').textContent = JSON.stringify(data, null, 2);
      if (data.status === 'signal_found') { updateProjectedMetrics(data); }
    }

    async function approveTrade() {
      const res = await fetch('/approve', { method: 'POST' });
      const data = await res.json();
      document.getElementById('tradeBox').textContent = JSON.stringify(data, null, 2);
    }

    async function monitorTrade() {
      const res = await fetch('/monitor');
      const data = await res.json();
      document.getElementById('monitorBox').textContent = JSON.stringify(data, null, 2);
    }

    async function resetDay() {
      await fetch('/reset-day', { method: 'POST' });
      location.reload();
    }
  </script>
</body>
</html>
